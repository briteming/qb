<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 Python 集成 GitHub App 和 GitHub Check API，构建持续集成服务 · QIWIHUI</title><meta name="description" content="使用 Python 集成 GitHub App 和 GitHub Check API，构建持续集成服务 - qiwihui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/nella.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-8935595858652656",
enable_page_level_ads: true
});
</script><link rel="search" type="application/opensearchdescription+xml" href="https://qiwihui.com/atom.xml" title="QIWIHUI"><meta property="og:site_name" content="QIWIHUI"><meta property="og:url" content="https://qiwihui.com/qiwihui-blog-111/index.html"><meta property="og:title" content="使用 Python 集成 GitHub App 和 GitHub Check API，构建持续集成服务"><meta property="og:description" content="使用 Python 集成 GitHub App 和 GitHub Check API，构建持续集成服务"><meta property="og:type" content="article"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/search/" target="_self" class="nav-list-link">SEARCH</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><!--li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") SEARCH--></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">使用 Python 集成 GitHub App 和 GitHub Check API，构建持续集成服务</h1><div class="post-info">Aug 13, 2022<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">#技术</a><span>9 min. read</span></div><div class="post-content"><p>这篇博客的起因是在做项目的过程中要求使用 Python 完成相应功能，现在将这部份代码按教程的流程发布出来。</p>
<p>原文<a href="https://docs.github.com/en/free-pro-team@latest/developers/apps/creating-ci-tests-with-the-checks-api" target="_blank" rel="noopener">《使用 Checks API 创建 CI 测试》</a>中使用 Ruby，现使用 Python 完成文档示例。由于教程已经将大部分内容详细描述了，本文只列出与原来教程有不同的步骤，以及对应的 Python 代码。</p>
<a id="more"></a>
<p>项目地址：<a href="https://github.com/qiwihui/githubappcheckruns" target="_blank" rel="noopener">qiwihui/githubappcheckruns</a></p>
<h2><span id="ji-ben-yao-qiu">基本要求</span></h2>
<p>文档：<a href="https://docs.github.com/cn/developers/apps/setting-up-your-development-environment-to-create-a-github-app" target="_blank" rel="noopener">https://docs.github.com/cn/developers/apps/setting-up-your-development-environment-to-create-a-github-app</a></p>
<ol>
<li>使用本地测试，利用 smee 转发 github 回调到本地</li>
</ol>
<p>访问 <a href="http://smee.io" target="_blank" rel="noopener">smee.io</a> 并创建一个新的 channel，比如 <a href="https://smee.io/LgDQ8xrhy0q2GeET%EF%BC%8C%E7%84%B6%E5%90%8E%E4%BD%BF%E7%94%A8" target="_blank" rel="noopener">https://smee.io/LgDQ8xrhy0q2GeET，然后使用</a> <code>pysmee</code> 命令运行如下命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装</span></span><br><span class="line">pip install pysmee</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行命令</span></span><br><span class="line">pysmee forward https://smee.io/LgDQ8xrhy0q2GeET http://localhost:5000/events</span><br></pre></td></tr></table></figure>
<p>或者使用项目目录 smee 中的 node 脚本运行</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">npm i</span><br><span class="line">npm run smee</span><br></pre></td></tr></table></figure>
<h2><span id="di-1-bu-fen-chuang-jian-jian-cha-api-jie-kou">第 1 部分 创建检查 API 接口</span></h2>
<h3><span id="bu-zou-1-1-geng-xin-ying-yong-cheng-xu-quan-xian">步骤 1.1. 更新应用程序权限</span></h3>
<p>主要为以下权限：</p>
<ul>
<li>Repository permissions
<ul>
<li>Checks: Read &amp; write</li>
<li>Contents: Read &amp; write</li>
<li>Pull requests: Read &amp; write</li>
</ul>
</li>
<li>Subscribe to events
<ul>
<li>check suite</li>
<li>check run</li>
</ul>
</li>
</ul>
<h3><span id="bu-zou-1-2-tian-jia-shi-jian-chu-li">步骤 1.2. 添加事件处理</span></h3>
<p>对应于 Ruby 中使用 Sinatra 作为 web 框架，我们使用 <code>Flask</code> 作为 web 框架，并结合 <code>PyGithub</code> 这个库提供的 github API 封装，由于 PyGithub 在发布的版本中还未集成 check run 对应的 API，所以使用其 <code>master</code> 分支上的代码，添加 <code>git+https://github.com/PyGithub/PyGithub.git</code> 到 requirements.txt 中。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">app = Flask(__name__)</span><br><span class="line">APP_NAME = <span class="string">"Octo PyLinter"</span></span><br><span class="line"></span><br><span class="line">app.config[<span class="string">"GITHUB_APP_ID"</span>] = config.GITHUB_APP_ID</span><br><span class="line">app.config[<span class="string">"GITHUB_KEY_FILE"</span>] = config.GITHUB_KEY_FILE</span><br><span class="line">app.config[<span class="string">"GITHUB_SECRET"</span>] = config.GITHUB_SECRET</span><br><span class="line">app.config[<span class="string">"GITHUB_APP_ROUTE"</span>] = config.GITHUB_APP_ROUTE</span><br><span class="line"></span><br><span class="line">github_app = GithubAppFlask(app)</span><br><span class="line"></span><br><span class="line"><span class="meta">@github_app.on(</span></span><br><span class="line">    [</span><br><span class="line">        <span class="string">"check_suite.requested"</span>,</span><br><span class="line">        <span class="string">"check_suite.rerequested"</span>,</span><br><span class="line">        <span class="string">"check_run.rerequested"</span>,</span><br><span class="line">    ]</span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_check_run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    client = github_app.github_app_installation.get_github_client()</span><br><span class="line">    head_sha = (</span><br><span class="line">        github_app.payload[<span class="string">"check_run"</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"check_run"</span> <span class="keyword">in</span> github_app.payload</span><br><span class="line">        <span class="keyword">else</span> github_app.payload[<span class="string">"check_suite"</span>][<span class="string">"head_sha"</span>]</span><br><span class="line">    )</span><br><span class="line">    repo = client.get_repo(github_app.payload[<span class="string">"repository"</span>][<span class="string">"full_name"</span>])</span><br><span class="line">    repo.create_check_run(name=APP_NAME, head_sha=head_sha)</span><br></pre></td></tr></table></figure>
<p>其中，<code>GithubAppFlask</code> 提供三个功能：</p>
<ol>
<li>提供 github_app 封装；</li>
<li>提供 <code>on</code> 装饰器，对于不同 github 动作分发处理；</li>
<li>github webhook 认证；</li>
</ol>
<h3><span id="bu-zou-1-3-chuang-jian-check-run">步骤 1.3. 创建 check run</span></h3>
<p>使用 PyGithub 库的 <code>create_check_run</code> 处理</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_check_run</span><span class="params">()</span>:</span></span><br><span class="line">    client = github_app.github_app_installation.get_github_client()</span><br><span class="line">    head_sha = (</span><br><span class="line">        github_app.payload[<span class="string">"check_run"</span>]</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"check_run"</span> <span class="keyword">in</span> github_app.payload</span><br><span class="line">        <span class="keyword">else</span> github_app.payload[<span class="string">"check_suite"</span>][<span class="string">"head_sha"</span>]</span><br><span class="line">    )</span><br><span class="line">    repo = client.get_repo(github_app.payload[<span class="string">"repository"</span>][<span class="string">"full_name"</span>])</span><br><span class="line">    repo.create_check_run(name=APP_NAME, head_sha=head_sha)</span><br></pre></td></tr></table></figure>
<h2><span id="bu-zou-1-4-geng-xin-check-run">步骤 1.4. 更新 check run</span></h2>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="meta">@github_app.on(["check_run.created"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initiate_check_run</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="string">"""Start the CI process"""</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Check that the event is being sent to this app</span></span><br><span class="line">    <span class="keyword">if</span> str(github_app.payload[<span class="string">"check_run"</span>][<span class="string">"app"</span>][<span class="string">"id"</span>]) == config.GITHUB_APP_ID:</span><br><span class="line">        client = github_app.github_app_installation.get_github_client()</span><br><span class="line">        repo = client.get_repo(github_app.payload[<span class="string">"repository"</span>][<span class="string">"full_name"</span>])</span><br><span class="line">        check_run = repo.get_check_run(github_app.payload[<span class="string">"check_run"</span>][<span class="string">"id"</span>])</span><br><span class="line">        <span class="comment"># Mark the check run as in process</span></span><br><span class="line">        check_run.edit(</span><br><span class="line">            name=APP_NAME,</span><br><span class="line">            status=<span class="string">"in_progress"</span>,</span><br><span class="line">            started_at=datetime.now(),</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># ***** RUN A CI TEST *****</span></span><br><span class="line">        <span class="comment"># 暂略</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Mark the check run as complete!</span></span><br><span class="line">        check_run.edit(</span><br><span class="line">            name=APP_NAME,</span><br><span class="line">            status=<span class="string">"completed"</span>,</span><br><span class="line">            completed_at=datetime.now(),</span><br><span class="line">            conclusion=conclusion</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h2><span id="di-2-bu-fen-chuang-jian-octo-rubocop-ci-ce-shi">第 2 部分 创建 Octo RuboCop CI 测试</span></h2>
<p>原教程使用 RuboCop 作为 ruby 代码语法检查和格式化工具，相对应，我们使用 <code>pylint</code> 作为 python 代码语法检查，使用 <code>autopep8</code> 作为格式化工具。
同样，对于git项目的操作，我们使用 <code>GitPython</code> 简化操作。</p>
<h2><span id="bu-zou-2-1-tian-jia-python-wen-jian">步骤 2.1. 添加 Python 文件</span></h2>
<p>添加要操作的 python 文件即可。</p>
<h3><span id="bu-zou-2-2-ke-long-cang-ku">步骤 2.2. 克隆仓库</span></h3>
<p>使用 GitPython 库处理，使用临时目录进行克隆。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clone_repository</span><span class="params">(full_repo_name, repository, ref, installation_token, clean=False)</span>:</span></span><br><span class="line">    repo_dir = tempfile.mkdtemp()</span><br><span class="line">    git.Git(repo_dir).clone(<span class="string">f"https://x-access-token:<span class="subst">&#123;installation_token&#125;</span>@github.com/<span class="subst">&#123;full_repo_name&#125;</span>.git"</span>)</span><br><span class="line">    <span class="comment"># pull and chekout</span></span><br><span class="line">    repo = git.Repo(<span class="string">f"<span class="subst">&#123;repo_dir&#125;</span>/<span class="subst">&#123;repository&#125;</span>"</span>)</span><br><span class="line">    repo.git.pull()</span><br><span class="line">    repo.git.checkout(ref)</span><br><span class="line">    <span class="keyword">if</span> clean:</span><br><span class="line">        shutil.rmtree(tempdir, ignore_errors=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> repo_dir</span><br></pre></td></tr></table></figure>
<p>运行 CI 测试：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ***** RUN A CI TEST *****</span></span><br><span class="line">full_repo_name = github_app.payload[<span class="string">"repository"</span>][<span class="string">"full_name"</span>]</span><br><span class="line">repository = github_app.payload[<span class="string">"repository"</span>][<span class="string">"name"</span>]</span><br><span class="line">head_sha = github_app.payload[<span class="string">"check_run"</span>][<span class="string">"head_sha"</span>]</span><br><span class="line">repo_dir = clone_repository(</span><br><span class="line">    full_repo_name,</span><br><span class="line">    repository,</span><br><span class="line">    head_sha,</span><br><span class="line">    installation_token=github_app.github_app_installation.token,</span><br><span class="line">    clean=<span class="literal">True</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3><span id="bu-zou-2-3-yun-xing-pylint">步骤 2.3. 运行 pylint</span></h3>
<p>pylint 运行并输出json结果。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">command = <span class="string">f"pylint <span class="subst">&#123;repo_dir&#125;</span>/<span class="subst">&#123;repository&#125;</span>/**/*.py -f json"</span></span><br><span class="line">report = subprocess.getoutput(command)</span><br><span class="line">shutil.rmtree(repo_dir)</span><br><span class="line">output = json.loads(report)</span><br></pre></td></tr></table></figure>
<h3><span id="bu-zou-2-4-shou-ji-pylint-cuo-wu">步骤 2.4. 收集 pylint 错误</span></h3>
<p>pylint结果与 <code>rubocop</code> 类似，收集并解析结果：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="comment"># lint</span></span><br><span class="line">max_annotations = <span class="number">50</span></span><br><span class="line"></span><br><span class="line">annotations = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># RuboCop reports the number of errors found in "offense_count"</span></span><br><span class="line"><span class="keyword">if</span> len(output) == <span class="number">0</span>:</span><br><span class="line">    conclusion = <span class="string">"success"</span></span><br><span class="line">    actions = <span class="literal">None</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    conclusion = <span class="string">"neutral"</span></span><br><span class="line">    <span class="keyword">for</span> file <span class="keyword">in</span> output:</span><br><span class="line"></span><br><span class="line">        file_path = re.sub(<span class="string">f"<span class="subst">&#123;repo_dir&#125;</span>/<span class="subst">&#123;repository&#125;</span>/"</span>, <span class="string">""</span>, file[<span class="string">"path"</span>])</span><br><span class="line">        annotation_level = <span class="string">"notice"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Parse each offense to get details and location</span></span><br><span class="line">        <span class="comment"># Limit the number of annotations to 50</span></span><br><span class="line">        <span class="keyword">if</span> max_annotations == <span class="number">0</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        max_annotations -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        start_line = file[<span class="string">"line"</span>]</span><br><span class="line">        end_line = file[<span class="string">"line"</span>]</span><br><span class="line">        start_column = file[<span class="string">"column"</span>]</span><br><span class="line">        end_column = file[<span class="string">"column"</span>]</span><br><span class="line">        message = file[<span class="string">"message"</span>]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Create a new annotation for each error</span></span><br><span class="line">        annotation = &#123;</span><br><span class="line">            <span class="string">"path"</span>: file_path,</span><br><span class="line">            <span class="string">"start_line"</span>: start_line,</span><br><span class="line">            <span class="string">"end_line"</span>: end_line,</span><br><span class="line">            <span class="string">"start_column"</span>: start_column,</span><br><span class="line">            <span class="string">"end_column"</span>: end_column,</span><br><span class="line">            <span class="string">"annotation_level"</span>: annotation_level,</span><br><span class="line">            <span class="string">"message"</span>: message,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment"># # Annotations only support start and end columns on the same line</span></span><br><span class="line">        <span class="comment"># if start_line == end_line:</span></span><br><span class="line">        <span class="comment">#     annotation.merge(&#123;"start_column": start_column, "end_column": end_column&#125;)</span></span><br><span class="line"></span><br><span class="line">        annotations.append(annotation)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># Need fix action</span></span><br><span class="line">    actions = [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"label"</span>: <span class="string">"Fix this"</span>,</span><br><span class="line">            <span class="string">"description"</span>: <span class="string">"Automatically fix all linter notices."</span>,</span><br><span class="line">            <span class="string">"identifier"</span>: <span class="string">"fix_rubocop_notices"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<h3><span id="bu-zou-2-5-shi-yong-ci-ce-shi-jie-guo-geng-xin-jian-cha-yun-xing">步骤 2.5. 使用 CI 测试结果更新检查运行</span></h3>
<p>整理结果，并添加修复动作：</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">summary = (</span><br><span class="line">    <span class="string">f"Summary\n"</span></span><br><span class="line">    <span class="string">f"- Offense count: <span class="subst">&#123;len(output)&#125;</span>\n"</span></span><br><span class="line">    <span class="string">f"- File count: <span class="subst">&#123;len(set([file[<span class="string">'path'</span>] <span class="keyword">for</span> file <span class="keyword">in</span> output]))&#125;</span>\n"</span></span><br><span class="line">)</span><br><span class="line">text = <span class="string">"Octo Pylinter version: pylint"</span></span><br><span class="line"><span class="comment"># Mark the check run as complete!</span></span><br><span class="line">check_run.edit(</span><br><span class="line">    name=APP_NAME,</span><br><span class="line">    status=<span class="string">"completed"</span>,</span><br><span class="line">    completed_at=datetime.now(),</span><br><span class="line">    conclusion=conclusion,</span><br><span class="line">    output=&#123;</span><br><span class="line">        <span class="string">"title"</span>: <span class="string">"Octo Pylinter"</span>,</span><br><span class="line">        <span class="string">"summary"</span>: summary,</span><br><span class="line">        <span class="string">"text"</span>: text,</span><br><span class="line">        <span class="string">"annotations"</span>: annotations,</span><br><span class="line">    &#125;,</span><br><span class="line">    actions=actions,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3><span id="bu-zou-2-6-zi-dong-xiu-fu-cuo-wu">步骤 2.6. 自动修复错误</span></h3>
<p>沿用 <code>fix_rubocop_notices</code> 这个 ID，使用 <code>autopep8</code> 做 python 文件的修正，将结果以 PR 的方式提交。</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line"><span class="meta">@github_app.on(["check_run.requested_action"])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">take_requested_action</span><span class="params">()</span>:</span></span><br><span class="line">    full_repo_name = github_app.payload[<span class="string">"repository"</span>][<span class="string">"full_name"</span>]</span><br><span class="line">    repository = github_app.payload[<span class="string">"repository"</span>][<span class="string">"name"</span>]</span><br><span class="line">    head_branch = github_app.payload[<span class="string">"check_run"</span>][<span class="string">"check_suite"</span>][<span class="string">"head_branch"</span>]</span><br><span class="line">    check_run_id = github_app.payload[<span class="string">"check_run"</span>][<span class="string">"id"</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> github_app.payload[<span class="string">"requested_action"</span>][<span class="string">"identifier"</span>] == <span class="string">"fix_rubocop_notices"</span>:</span><br><span class="line">        repo_dir = clone_repository(</span><br><span class="line">            full_repo_name,</span><br><span class="line">            repository,</span><br><span class="line">            head_branch,</span><br><span class="line">            installation_token=github_app.github_app_installation.token,</span><br><span class="line">        )</span><br><span class="line">        <span class="comment"># Automatically correct style errors</span></span><br><span class="line">        <span class="comment"># fix with autopep8</span></span><br><span class="line">        command = <span class="string">f"autopep8 -a -i <span class="subst">&#123;repo_dir&#125;</span>/<span class="subst">&#123;repository&#125;</span>/**/*.py"</span></span><br><span class="line">        report = subprocess.getoutput(command)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># create new branch</span></span><br><span class="line">        new_branch = <span class="string">f"fix_rubocop_notices_<span class="subst">&#123;check_run_id&#125;</span>"</span></span><br><span class="line">        pushed = <span class="literal">False</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            repo = git.Repo(<span class="string">f"<span class="subst">&#123;repo_dir&#125;</span>/<span class="subst">&#123;repository&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">if</span> repo.index.diff(<span class="literal">None</span>) <span class="keyword">or</span> repo.untracked_files:</span><br><span class="line">                current = repo.create_head(new_branch)</span><br><span class="line">                current.checkout()</span><br><span class="line">                repo.config_writer().set_value(<span class="string">"user"</span>, <span class="string">"name"</span>, config.GITHUB_APP_USER_NAME).release()</span><br><span class="line">                repo.config_writer().set_value(<span class="string">"user"</span>, <span class="string">"email"</span>, config.GITHUB_APP_USER_EMAIL).release()</span><br><span class="line">                repo.git.add(update=<span class="literal">True</span>)</span><br><span class="line">                repo.git.commit(<span class="string">"-m"</span>, <span class="string">"Automatically fix Octo RuboCop notices."</span>)</span><br><span class="line">                repo.git.push(<span class="string">"--set-upstream"</span>, <span class="string">"origin"</span>, current)</span><br><span class="line">                pushed = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">"no changes"</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            print(<span class="string">"failed to commit and push"</span>)</span><br><span class="line">            <span class="comment"># # Nothing to commit!</span></span><br><span class="line">            <span class="comment"># print("Nothing to commit")</span></span><br><span class="line">        <span class="keyword">finally</span>:</span><br><span class="line">            shutil.rmtree(repo_dir, ignore_errors=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pushed:</span><br><span class="line">            <span class="comment"># create pull request</span></span><br><span class="line">            client = github_app.github_app_installation.get_github_client()</span><br><span class="line">            repo = client.get_repo(full_repo_name)</span><br><span class="line">            body = <span class="string">"""Automatically fix Octo RuboCop notices."""</span></span><br><span class="line">            pr = repo.create_pull(</span><br><span class="line">                title=<span class="string">"Automatically fix Octo RuboCop notices."</span>, body=body, head=new_branch, base=<span class="string">"master"</span></span><br><span class="line">            )</span><br><span class="line">            print(<span class="string">f"Pull Request number: <span class="subst">&#123;pr.number&#125;</span>"</span>)</span><br></pre></td></tr></table></figure>
<p>在以上步骤的基础上，可以构建更复杂的测试过程，完成不同的需求。</p>
<blockquote>
<p>GitHub repo: <a href="https://github.com/qiwihui/blog" target="_blank" rel="noopener">qiwihui/blog</a></p>
<p>Follow me: <a href="https://github.com/qiwihui" target="_blank" rel="noopener">@qiwihui</a></p>
<p>Site: <a href="https://qiwihui.com">QIWIHUI</a></p>
</blockquote>
<h3><span id="comments">Comments</span></h3>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/%E6%8A%80%E6%9C%AF/">#技术</a><a href="/tags/Python/">#Python</a></p></article></div><div class="post-copyright"><blockquote><p>版权声明：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">署名-相同方式共享 | CC BY-SA 4.0 </a>许可协议。</p></blockquote></div><footer><div class="paginator"><a href="/qiwihui-blog-48/" class="prev">PREV</a><a href="/qiwihui-blog-125/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'blog-qiwihui-com';
var disqus_identifier = 'qiwihui-blog-111/';
var disqus_title = '使用 Python 集成 GitHub App 和 GitHub Check API，构建持续集成服务';
var disqus_url = 'https://qiwihui.com/qiwihui-blog-111/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-qiwihui-com.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ["script","noscript","style","textarea","code","pre"]
    }
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46660488-3",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>