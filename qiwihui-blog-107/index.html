<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 用 Rust Actix-web 写一个 Todo 应用（三）── migrations 和错误处理 · QIWIHUI</title><meta name="description" content="用 Rust Actix-web 写一个 Todo 应用（三）── migrations 和错误处理 - qiwihui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/nella.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-8935595858652656",
enable_page_level_ads: true
});
</script><link rel="search" type="application/opensearchdescription+xml" href="https://qiwihui.com/atom.xml" title="QIWIHUI"><meta property="og:site_name" content="QIWIHUI"><meta property="og:url" content="https://qiwihui.com/qiwihui-blog-107/index.html"><meta property="og:title" content="用 Rust Actix-web 写一个 Todo 应用（三）── migrations 和错误处理"><meta property="og:description" content="用 Rust Actix-web 写一个 Todo 应用（三）── migrations 和错误处理"><meta property="og:type" content="article"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/search/" target="_self" class="nav-list-link">SEARCH</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><!--li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") SEARCH--></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">用 Rust Actix-web 写一个 Todo 应用（三）── migrations 和错误处理</h1><div class="post-info">Aug 13, 2022<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">#技术</a><span>5 min. read</span></div><div class="post-content"><h2><span id="shi-yong-diesel-guan-li-shu-ju-ku-bian-hua">使用 diesel 管理数据库变化</span></h2>
<p>diesel 是一个用 rust 写的 ORM 库，支持多种数据库，同时 diesel 提供了对数据库结构的管理功能。我们将使用 diesel 对我们的数据库结构变化进行管理。</p>
<a id="more"></a>
<p>首先，安装命令行工具 <code>diesel_cli</code>，并初始化数据库设置</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span> 安装 diesel_cli，支持 postgres</span><br><span class="line">cargo install diesel_cli --no-default-features --features postgres</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span> 设置数据库连接</span><br><span class="line">echo DATABASE_URL=postgres://actix:actix@localhost:5432/actix &gt;&gt; .env</span><br><span class="line"><span class="meta">#</span> 生成 diesel.toml 文件指向 schema 所在</span><br><span class="line">diesel setup</span><br><span class="line"><span class="meta">#</span> 创建数据库 migration</span><br><span class="line">diesel migration generate create_db</span><br></pre></td></tr></table></figure>
<p>在生成的 <code>migrations</code> 目录中，填入数据库变化的 sql 语句，<code>up.sql</code> 用于修改，<code>down.sql</code> 用于撤销修改。</p>
<p><code>up.sql</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> todo_list (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>,</span><br><span class="line">    title <span class="built_in">varchar</span>(<span class="number">150</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> todo_item (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">serial</span> primary <span class="keyword">key</span>,</span><br><span class="line">    title <span class="built_in">varchar</span>(<span class="number">150</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    checked <span class="built_in">boolean</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="literal">false</span>,</span><br><span class="line">    list_id <span class="built_in">integer</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    <span class="keyword">foreign</span> <span class="keyword">key</span> (list_id) <span class="keyword">references</span> todo_list(<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p><code>down.sql</code>：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> todo_item;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> todo_list;</span><br></pre></td></tr></table></figure>
<p>由于之前已经有对应的数据表结构，需要将原来的表结构删除，再运行数据库变更：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta">#</span> 删除原有的数据表之后</span><br><span class="line">diesel migrations run</span><br></pre></td></tr></table></figure>
<p>其中，对应生成的 schema 为：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">table! &#123;</span><br><span class="line">    todo_item (id) &#123;</span><br><span class="line">        id -&gt; Int4,</span><br><span class="line">        title -&gt; Varchar,</span><br><span class="line">        checked -&gt; Bool,</span><br><span class="line">        list_id -&gt; Int4,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table! &#123;</span><br><span class="line">    todo_list (id) &#123;</span><br><span class="line">        id -&gt; Int4,</span><br><span class="line">        title -&gt; Varchar,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">joinable!(todo_item -&gt; todo_list (list_id));</span><br><span class="line"></span><br><span class="line">allow_tables_to_appear_in_same_query!(</span><br><span class="line">    todo_item,</span><br><span class="line">    todo_list,</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>此时，数据库中的表机构就和我们之前是一样的，同时增加了一个用于记录已经做过的 migrations 的数据库。</p>
<h2><span id="orm">ORM</span></h2>
<p>鉴于 diesel 没有 async 版本，以及 quaint 不是 type-safe，不做 ORM 的支持。</p>
<h2><span id="cuo-wu-chu-li">错误处理</span></h2>
<p>自定义错误，并将常见的错误统一处理。</p>
<p>新增 <code>errors.rs</code>：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line"><span class="keyword">use</span> actix_web::http::StatusCode;</span><br><span class="line"><span class="keyword">use</span> actix_web::&#123;HttpResponse, ResponseError&#125;;</span><br><span class="line"><span class="keyword">use</span> deadpool_postgres::PoolError;</span><br><span class="line"><span class="keyword">use</span> serde::&#123;Deserialize, Serialize&#125;;</span><br><span class="line"><span class="keyword">use</span> std::fmt;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug)]</span></span><br><span class="line"><span class="meta">#[allow(dead_code)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">enum</span> <span class="title">Error</span></span> &#123;</span><br><span class="line">    InternalServerError(<span class="built_in">String</span>),</span><br><span class="line">    NotFound(<span class="built_in">String</span>),</span><br><span class="line">    PoolError(<span class="built_in">String</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#[derive(Debug, Serialize, Deserialize)]</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">ErrorResponse</span></span> &#123;</span><br><span class="line">    errors: <span class="built_in">Vec</span>&lt;<span class="built_in">String</span>&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> fmt::Display <span class="keyword">for</span> Error &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fmt</span></span>(&amp;<span class="keyword">self</span>, f: &amp;<span class="keyword">mut</span> fmt::Formatter&lt;<span class="symbol">'_</span>&gt;) -&gt; fmt::<span class="built_in">Result</span> &#123;</span><br><span class="line">        <span class="built_in">write!</span>(f, <span class="string">"&#123;&#125;"</span>, <span class="keyword">self</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> ResponseError <span class="keyword">for</span> Error &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">error_response</span></span>(&amp;<span class="keyword">self</span>) -&gt; HttpResponse &#123;</span><br><span class="line">        <span class="keyword">match</span> <span class="keyword">self</span> &#123;</span><br><span class="line">            Error::NotFound(message) =&gt; &#123;</span><br><span class="line">                HttpResponse::NotFound().json::&lt;ErrorResponse&gt;(message.into())</span><br><span class="line">            &#125;</span><br><span class="line">            _ =&gt; HttpResponse::new(StatusCode::INTERNAL_SERVER_ERROR),</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 支持 字符串 into</span></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;&amp;<span class="built_in">String</span>&gt; <span class="keyword">for</span> ErrorResponse &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(error: &amp;<span class="built_in">String</span>) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        ErrorResponse &#123;</span><br><span class="line">            errors: <span class="built_in">vec!</span>[error.into()],</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理 PoolError</span></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">From</span>&lt;PoolError&gt; <span class="keyword">for</span> Error &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">from</span></span>(error: PoolError) -&gt; <span class="keyword">Self</span> &#123;</span><br><span class="line">        Error::PoolError(error.to_string())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修改 <code>db.rs</code>：</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">+<span class="keyword">use</span> crate::errors::Error;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">-        <span class="literal">None</span> =&gt; <span class="literal">Err</span>(Error::new(ErrorKind::NotFound, <span class="string">"Not found"</span>)),</span><br><span class="line">+        <span class="literal">None</span> =&gt; <span class="literal">Err</span>(Error::NotFound(<span class="string">"Not found"</span>.into())),</span><br></pre></td></tr></table></figure>
<p>修改 <code>handlers.rs</code>，其中一个请求处理</p>
<figure class="highlight rust"><table><tr><td class="code"><pre><span class="line">+<span class="keyword">use</span> crate::errors::Error;</span><br><span class="line"><span class="comment">// error_response：items from traits can only be used if the trait is in scope</span></span><br><span class="line">+<span class="keyword">use</span> actix_web::ResponseError;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">-<span class="keyword">pub</span> <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">todos</span></span>(state: web::Data&lt;AppState&gt;) -&gt; <span class="keyword">impl</span> Responder &#123;</span><br><span class="line">+<span class="keyword">pub</span> <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">todos</span></span>(state: web::Data&lt;AppState&gt;) -&gt; <span class="built_in">Result</span>&lt;HttpResponse, Error&gt; &#123;</span><br><span class="line">     <span class="keyword">let</span> client: Client = state</span><br><span class="line">         .pool</span><br><span class="line">         .get()</span><br><span class="line">@@ -<span class="number">33</span>,<span class="number">12</span> +<span class="number">34</span>,<span class="number">15</span> @@ <span class="keyword">pub</span> <span class="keyword">async</span> <span class="function"><span class="keyword">fn</span> <span class="title">todos</span></span>(state: web::Data&lt;AppState&gt;) -&gt; <span class="keyword">impl</span> Responder &#123;</span><br><span class="line">         .expect(<span class="string">"Error connecting to the database"</span>);</span><br><span class="line">     <span class="keyword">let</span> result = db::get_todos(&amp;client).<span class="keyword">await</span>;</span><br><span class="line">     <span class="keyword">match</span> result &#123;</span><br><span class="line">-        <span class="literal">Ok</span>(todos) =&gt; HttpResponse::<span class="literal">Ok</span>().json(todos),</span><br><span class="line">-        <span class="literal">Err</span>(_) =&gt; HttpResponse::InternalServerError().into(),</span><br><span class="line">+        <span class="literal">Ok</span>(todos) =&gt; <span class="literal">Ok</span>(HttpResponse::<span class="literal">Ok</span>().json(todos)),</span><br><span class="line">+        <span class="literal">Err</span>(e) =&gt; <span class="literal">Ok</span>(e.error_response()),</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2><span id="xiao-jie">小结</span></h2>
<ol>
<li>管理数据库结构变更；</li>
<li>自定义错误处理</li>
</ol>
<h2><span id="can-kao-wen-dang-he-xiang-mu">参考文档和项目</span></h2>
<ol>
<li><a href="https://www.youtube.com/watch?v=gQwA0g0NNSI" target="_blank" rel="noopener">Creating a simple TODO service with Actix</a></li>
<li><a href="actix.rs">actix-web 官方文档</a></li>
<li><a href="https://github.com/actix/examples" target="_blank" rel="noopener">官方 actix-web 示例</a></li>
</ol>
<blockquote>
<p>GitHub repo: <a href="https://github.com/qiwihui/blog" target="_blank" rel="noopener">qiwihui/blog</a></p>
<p>Follow me: <a href="https://github.com/qiwihui" target="_blank" rel="noopener">@qiwihui</a></p>
<p>Site: <a href="https://qiwihui.com">QIWIHUI</a></p>
</blockquote>
<h3><span id="comments">Comments</span></h3>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/%E6%8A%80%E6%9C%AF/">#技术</a><a href="/tags/Rust/">#Rust</a></p></article></div><div class="post-copyright"><blockquote><p>版权声明：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">署名-相同方式共享 | CC BY-SA 4.0 </a>许可协议。</p></blockquote></div><footer><div class="paginator"><a href="/qiwihui-blog-97/" class="prev">PREV</a><a href="/qiwihui-blog-133/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'blog-qiwihui-com';
var disqus_identifier = 'qiwihui-blog-107/';
var disqus_title = '用 Rust Actix-web 写一个 Todo 应用（三）── migrations 和错误处理';
var disqus_url = 'https://qiwihui.com/qiwihui-blog-107/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-qiwihui-com.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ["script","noscript","style","textarea","code","pre"]
    }
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46660488-3",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>