<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 使用 Merkle 树做 NFT 白名单验证 · QIWIHUI</title><meta name="description" content="使用 Merkle 树做 NFT 白名单验证 - qiwihui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/nella.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-8935595858652656",
enable_page_level_ads: true
});
</script><link rel="search" type="application/opensearchdescription+xml" href="https://qiwihui.com/atom.xml" title="QIWIHUI"><meta property="og:site_name" content="QIWIHUI"><meta property="og:url" content="https://qiwihui.com/qiwihui-blog-151/index.html"><meta property="og:title" content="使用 Merkle 树做 NFT 白名单验证"><meta property="og:description" content="使用 Merkle 树做 NFT 白名单验证"><meta property="og:type" content="article"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/search/" target="_self" class="nav-list-link">SEARCH</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><!--li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") SEARCH--></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">使用 Merkle 树做 NFT 白名单验证</h1><div class="post-info">May 15, 2024<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">#技术</a><span>6 min. read</span></div><div class="post-content"><p>Merkle 树现在普遍用来做线上数据验证。这篇文章主要解释和实现使用 Merkle 树做 NFT 白名单验证。</p>
<p>使用 Merkle 树做 NFT 白名单验证，简单来说就是将所有的白名单钱包地址做为 Merkle 树的叶节点生成一棵 Merkle 树，在部署的NFT 合约中只存储 Merkle 树的 root hash，这样避免了在合约中存储所有白名单地址带来的高额 gas 费用。在 mint 时，前端生成钱包地址的 Merkle proof，调用合约进行验证即可。</p>
<a id="more"></a>
<p>一次验证过程前端和合约运行过程如图：</p>
<p><img src="https://user-images.githubusercontent.com/3297411/150952521-2c104057-33b9-488e-94d4-c5570767e61b.png" alt="Untitled"></p>
<p>图片来自 [3]</p>
<h3><span id="merkle-shu">Merkle 树</span></h3>
<p>详情请参见：<a href="https://en.wikipedia.org/wiki/Merkle_tree" target="_blank" rel="noopener">https://en.wikipedia.org/wiki/Merkle_tree</a></p>
<p><img src="https://user-images.githubusercontent.com/3297411/150952561-e4186a0c-a437-4dfc-a037-7fc2965597c3.png" alt="Untitled 1"></p>
<p>图片来自 [1]</p>
<p>比如，以水果单词作为叶节点，生成 Merkle 树的结构如下：</p>
<p><img src="https://user-images.githubusercontent.com/3297411/150952596-213c31de-514e-48fe-8d2f-3b382e730bc5.png" alt="Untitled 2"></p>
<p>图片来自 [2]</p>
<h3><span id="he-yue-shi-xian">合约实现</span></h3>
<p>我们简单实现 Merkle 验证的过程，此合约包含以下功能：</p>
<ol>
<li>设置 Merkle 根哈希： <code>setSaleMerkleRoot</code></li>
<li>验证 Merkle proof： <code>isValidMerkleProof</code></li>
<li>mint 并记录是否已经mint： <code>mint</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">//SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;@openzeppelin/contracts/access/Ownable.sol&quot;;</span><br><span class="line">import &quot;@openzeppelin/contracts/utils/cryptography/MerkleProof.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Merkle is Ownable &#123;</span><br><span class="line">    bytes32 public saleMerkleRoot;</span><br><span class="line">    mapping(address =&gt; bool) public claimed;</span><br><span class="line"></span><br><span class="line">    function setSaleMerkleRoot(bytes32 merkleRoot) external onlyOwner &#123;</span><br><span class="line">        saleMerkleRoot = merkleRoot;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier isValidMerkleProof(bytes32[] calldata merkleProof, bytes32 root) &#123;</span><br><span class="line">        require(</span><br><span class="line">            MerkleProof.verify(</span><br><span class="line">                merkleProof,</span><br><span class="line">                root,</span><br><span class="line">                keccak256(abi.encodePacked(msg.sender))</span><br><span class="line">            ),</span><br><span class="line">            &quot;Address does not exist in list&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function mint(bytes32[] calldata merkleProof)</span><br><span class="line">        external</span><br><span class="line">        isValidMerkleProof(merkleProof, saleMerkleRoot)</span><br><span class="line">    &#123;</span><br><span class="line">        require(!claimed[msg.sender], &quot;Address already claimed&quot;);</span><br><span class="line">        claimed[msg.sender] = true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="merkle-proof-zheng-ming-sheng-cheng">Merkle proof 证明生成</span></h3>
<p>调用合约验证的 Merkle proof 需要在前端生成。生成过程需要用到 <code>merkletreejs</code>和 <code>keccak256</code> 两个库，前者用于创建 Merkle 树，后者用于生成哈希。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save merkletreejs keccak256</span><br></pre></td></tr></table></figure>
<p>第一步，生成白名单地址的 Merkle 树：</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; MerkleTree &#125; = <span class="built_in">require</span>(<span class="string">'merkletreejs'</span>);</span><br><span class="line"><span class="keyword">const</span> keccak256 = <span class="built_in">require</span>(<span class="string">'keccak256'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> whitelistAddresses = [</span><br><span class="line">    <span class="string">'0x169841AA3024cfa570024Eb7Dd6Bf5f774092088'</span>,</span><br><span class="line">    <span class="string">'0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33'</span>,</span><br><span class="line">    <span class="string">'0x0a290c8cE7C35c40F4F94070a9Ed592fC85c62B9'</span>,</span><br><span class="line">    <span class="string">'0x43Be076d3Cd709a38D2f83Cd032297a194196517'</span>,</span><br><span class="line">    <span class="string">'0xC7FaB03eecA24CcaB940932559C5565a4cE9cFFb'</span>,</span><br><span class="line">    <span class="string">'0xE4336D25e9Ca0703b574a6fd1b342A4d0327bcfa'</span>,</span><br><span class="line">    <span class="string">'0xeDcB8a28161f966C5863b8291E80dDFD1eB78491'</span>,</span><br><span class="line">    <span class="string">'0x77cbd0fa30F83a249da282e9fE90A86d7936FdE7'</span>,</span><br><span class="line">    <span class="string">'0xc39F9406284CcAeB426D0039a3F6ADe14573BaFe'</span>,</span><br><span class="line">    <span class="string">'0x16Beb6b55F145E4269279B82c040B7435f1088Ee'</span>,</span><br><span class="line">    <span class="string">'0x900b2909127Dff529f8b4DB3d83b957E6aE964c2'</span>,</span><br><span class="line">    <span class="string">'0xeA2A799793cE3D2eC6BcD066563f385F25401e95'</span>,</span><br><span class="line">];</span><br><span class="line"><span class="keyword">let</span> leafNodes = whitelistAddresses.map(<span class="function"><span class="params">address</span> =&gt;</span> keccak256(address));</span><br><span class="line"><span class="keyword">let</span> tree = <span class="keyword">new</span> MerkleTree(leafNodes, keccak256, &#123; <span class="attr">sortPairs</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Tree: '</span>, tree.toString());</span><br><span class="line"><span class="comment">// const root = tree.getRoot();</span></span><br><span class="line"><span class="comment">// console.log('Root hash is: ', root.toString('hex'));</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Tree:  └─ c7ec7ffb250de2b95a1c690751b2826ec9d2999dd9f5c6f8816655b1590ca544</span></span><br><span class="line"><span class="comment">//    ├─ 25f76dfbdd295dd14932a7aae9350055e72e9e317cd389c62d525884cc0d0f17</span></span><br><span class="line"><span class="comment">//    │  ├─ 0613ec9d9455eaa91ffd480afaa50db8952ccf3cf1f04375f08f848dca194a86</span></span><br><span class="line"><span class="comment">//    │  │  ├─ e0c3820340c8c58fa46f9ff9c8da5037a8f544f839abe168b76aff3fa391e177</span></span><br><span class="line"><span class="comment">//    │  │  │  ├─ 1575cc1dded49f942913392f94716824d29b8fa45876b2db6295d16a606533a4</span></span><br><span class="line"><span class="comment">//    │  │  │  └─ 6abf3666623175adbce354196686c5e9853334b8eeb8324726a8ca89290c26d1</span></span><br><span class="line"><span class="comment">//    │  │  └─ 6c42c6099e51e28eef8f19f71765bb42c571d5c7177996f177606138f65c0c2b</span></span><br><span class="line"><span class="comment">//    │  │     ├─ 4d313ef5510345a10724e131139b4556d77adaa109ba87087a600ea00bf92d18</span></span><br><span class="line"><span class="comment">//    │  │     └─ 83260aa668bd8b075be8e34c6f6609ad5be3eee1470f7b30f46e85650097cb98</span></span><br><span class="line"><span class="comment">//    │  └─ b0d6f760008340e3f60414d84b305702faa6418f44f31de07b10e05bf369eb3b</span></span><br><span class="line"><span class="comment">//    │     ├─ f1e3a4717b4179aecf418fc3a0c92c728828ee399700d9bcb512c6424f86cb7b</span></span><br><span class="line"><span class="comment">//    │     │  ├─ e00eb5681327801ed923ce4913468e70f833de797cfbc3df1e68dd13000f1fa6</span></span><br><span class="line"><span class="comment">//    │     │  └─ d71c2d63734c3ca3c4257d118442c5796796234f77bb325759973b90e130dc62</span></span><br><span class="line"><span class="comment">//    │     └─ 07ff91a64cd06c27a059056430bddfdf2d54e8833c0ccaa4642b39ed3b22579f</span></span><br><span class="line"><span class="comment">//    │        ├─ 74b490baa6a881c8934d0aacc7fd778d1bac1e259f17856fccea372b6978bad6</span></span><br><span class="line"><span class="comment">//    │        └─ 3845f80821bbaa15e35bfe9ace50761f9adeebf25b8472fae6e4ff0db394b2da</span></span><br><span class="line"><span class="comment">//    └─ 4c880bf401add28c4e51270dfe16b28c3ca1b3d263ff7c5863fc8214b4046364</span></span><br><span class="line"><span class="comment">//       └─ 4c880bf401add28c4e51270dfe16b28c3ca1b3d263ff7c5863fc8214b4046364</span></span><br><span class="line"><span class="comment">//          ├─ 52a3b2fbc6bb6ee25b925ac9767246ceb24fd99c64a7dbc72847e6dc8dc52b81</span></span><br><span class="line"><span class="comment">//          │  ├─ a61d6c75021de68e08a03f83d25738ac77e5e5cce1a63b4d48c2c819254b4375</span></span><br><span class="line"><span class="comment">//          │  └─ 85c68207164ed77f53351eac1a14074cf5cd5b0fb1a664709adcd0ee4aa4ea8d</span></span><br><span class="line"><span class="comment">//          └─ 1689b05d03db07df6c1f227c6f2ad46646a3edf11684c8081b821abbaf45a6dc</span></span><br><span class="line"><span class="comment">//             ├─ 93b5a65af2ac0633f9f90c6e05c89c30e1d4aba0b6f98d2c2b9bda4118538d9f</span></span><br><span class="line"><span class="comment">//             └─ 159859f50ff6cca7ef1060dcbc1a8daf59820817ea262f3f6107b431024eb9c4</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到根哈希值为 <code>0xc7ec7ffb250de2b95a1c690751b2826ec9d2999dd9f5c6f8816655b1590ca544</code> ，这个值在调用合约函数 <code>setSaleMerkleRoot</code> 时需要用到，会保存在合约中。生成的 Merkle 证明需要存储在页面中，也可以存在 IPFS 中，在使用时加载使用。</p>
<p>第二步，需要生成参与 mint 地址的 Merkle 证明，假设使用 <code>0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33</code> 地址进行 mint 操作：</p>
<figure class="highlight jsx"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> leaf = keccak256(<span class="string">'0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33'</span>);</span><br><span class="line"><span class="keyword">let</span> proof = tree.getHexProof(leaf);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Proof of 0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33: '</span>, proof);</span><br></pre></td></tr></table></figure>
<p>对应生成的证明为</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Proof of 0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33:  [</span><br><span class="line">    <span class="string">'0x1575cc1dded49f942913392f94716824d29b8fa45876b2db6295d16a606533a4'</span>,</span><br><span class="line">    <span class="string">'0x6c42c6099e51e28eef8f19f71765bb42c571d5c7177996f177606138f65c0c2b'</span>,</span><br><span class="line">    <span class="string">'0xb0d6f760008340e3f60414d84b305702faa6418f44f31de07b10e05bf369eb3b'</span>,</span><br><span class="line">    <span class="string">'0x4c880bf401add28c4e51270dfe16b28c3ca1b3d263ff7c5863fc8214b4046364'</span></span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>
<p>同时我们将生成一个假的证明：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// another proof, for example</span><br><span class="line"></span><br><span class="line">let anotherWhitelistAddresses = [</span><br><span class="line">    &apos;0x169841AA3024cfa570024Eb7Dd6Bf5f774092088&apos;,</span><br><span class="line">    &apos;0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33&apos;,</span><br><span class="line">    &apos;0x0a290c8cE7C35c40F4F94070a9Ed592fC85c62B9&apos;,</span><br><span class="line">    &apos;0x43Be076d3Cd709a38D2f83Cd032297a194196517&apos;,</span><br><span class="line">];</span><br><span class="line">let anotherLeafNodes = anotherWhitelistAddresses.map(address =&gt; keccak256(address));</span><br><span class="line">let badTree = new MerkleTree(anotherLeafNodes, keccak256, &#123; sortPairs: true &#125;);</span><br><span class="line"></span><br><span class="line">let badLeaf = keccak256(&apos;0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33&apos;);</span><br><span class="line">let badProof = badTree.getHexProof(badLeaf);</span><br><span class="line">console.log(&apos;Bad proof of 0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33: &apos;, badProof);</span><br><span class="line"></span><br><span class="line">// Bad proof of 0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33:  [</span><br><span class="line">//     &apos;0x1575cc1dded49f942913392f94716824d29b8fa45876b2db6295d16a606533a4&apos;,</span><br><span class="line">//     &apos;0x6c42c6099e51e28eef8f19f71765bb42c571d5c7177996f177606138f65c0c2b&apos;</span><br><span class="line">//   ]</span><br></pre></td></tr></table></figure>
<h3><span id="yan-zheng-guo-cheng">验证过程</span></h3>
<p>此过程将使用 Remix IDE 进行部署和测试：</p>
<ol>
<li>
<p>使用 Remix 将合约部署到以太坊测试网 <code>Rinkeby</code> 中，得到合约地址为： <code>0xb3E2409199855ea9676dc5CFc9DefFd4A1b93eFe</code> ；</p>
</li>
<li>
<p>调用 <code>setSaleMerkleRoot</code> 设置 Merkle 根哈希为 <code>0xc7ec7ffb250de2b95a1c690751b2826ec9d2999dd9f5c6f8816655b1590ca544</code> ；</p>
</li>
<li>
<p>调用 <code>mint</code> ，传入非法 Merkle 证明：<code>[&quot;0x1575cc1dded49f942913392f94716824d29b8fa45876b2db6295d16a606533a4&quot;,&quot;0x6c42c6099e51e28eef8f19f71765bb42c571d5c7177996f177606138f65c0c2b&quot;]</code> ，可以看到<a href="https://rinkeby.etherscan.io/tx/0xc21a4f27c80f1427b703da1bccdceb58528e4ba52ac0023430391f4cb9c7ac34" target="_blank" rel="noopener">交易</a>失败，显示 <code>Fail with error 'Address does not exist in list</code> ；</p>
</li>
<li>
<p>验证 <code>0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33</code> 地址对应 mint 状态是否为 false；</p>
</li>
<li>
<p>调用 <code>mint</code>，传入合法的 Merkle 证明：</p>
<p><code>[&quot;0x1575cc1dded49f942913392f94716824d29b8fa45876b2db6295d16a606533a4&quot;,&quot;0x6c42c6099e51e28eef8f19f71765bb42c571d5c7177996f177606138f65c0c2b&quot;,&quot;0xb0d6f760008340e3f60414d84b305702faa6418f44f31de07b10e05bf369eb3b&quot;,&quot;0x4c880bf401add28c4e51270dfe16b28c3ca1b3d263ff7c5863fc8214b4046364&quot;]</code>，可以看到交易成功；</p>
</li>
<li>
<p>验证 <code>0xc12ae5Ba30Da6eB11978939379D383beb5Df9b33</code> 地址对应 mint 状态是否为 <code>true</code>。</p>
</li>
</ol>
<p>。</p>
<h3><span id="can-kao-wen-zhang">参考文章</span></h3>
<ol>
<li><a href="https://medium.com/@ItsCuzzo/using-merkle-trees-for-nft-whitelists-523b58ada3f9" target="_blank" rel="noopener">Using Merkle Trees for NFT Whitelists</a></li>
<li><a href="https://medium.com/@jgm.orinoco/understanding-merkle-pollards-1547fc7efaa" target="_blank" rel="noopener">Understanding Merkle pollards</a></li>
<li><a href="https://litentry.medium.com/litentry-weekly-report-nft-pallet-and-merkle-airdrop-f0fe7a32a7da" target="_blank" rel="noopener">Litentry this week: NFT pallet and Merkle airdrop</a></li>
</ol>
<h3><span id="comments">Comments</span></h3>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/">#区块链</a></p></article></div><div class="post-copyright"><blockquote><p>版权声明：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">署名-相同方式共享 | CC BY-SA 4.0 </a>许可协议。</p></blockquote></div><footer><div class="paginator"><a href="/qiwihui-blog-148/" class="prev">PREV</a><a href="/qiwihui-blog-149/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'blog-qiwihui-com';
var disqus_identifier = 'qiwihui-blog-151/';
var disqus_title = '使用 Merkle 树做 NFT 白名单验证';
var disqus_url = 'https://qiwihui.com/qiwihui-blog-151/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-qiwihui-com.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ["script","noscript","style","textarea","code","pre"]
    }
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46660488-3",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>