<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Crypto Coven 加密女巫 NFT 合约解读 · QIWIHUI</title><meta name="description" content="Crypto Coven 加密女巫 NFT 合约解读 - qiwihui"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/nella.css"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.12/css/all.css" integrity="sha384-G0fIWCsCzJIMAVNQPfjH08cyYaUtMwjJwqiRKxxE/rx96Uroj1BtIQ6MLJuheaO9" crossorigin="anonymous"><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
google_ad_client: "ca-pub-8935595858652656",
enable_page_level_ads: true
});
</script><link rel="search" type="application/opensearchdescription+xml" href="https://qiwihui.com/atom.xml" title="QIWIHUI"><meta property="og:site_name" content="QIWIHUI"><meta property="og:url" content="https://qiwihui.com/qiwihui-blog-152/index.html"><meta property="og:title" content="Crypto Coven 加密女巫 NFT 合约解读"><meta property="og:description" content="Crypto Coven 加密女巫 NFT 合约解读"><meta property="og:type" content="article"><script src="//code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/images/avatar.jpg" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="/about/" target="_self" class="nav-list-link">ABOUT</a></li><li class="nav-list-item"><a href="/search/" target="_self" class="nav-list-link">SEARCH</a></li><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">HOME</a></li><li class="nav-list-item"><a href="/projects/" target="_self" class="nav-list-link">PROJECTS</a></li><li class="nav-list-item"><a href="/tags/" target="_self" class="nav-list-link">TAGS</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li><li class="nav-list-item"><a href="/links/" target="_self" class="nav-list-link">LINKS</a></li><!--li.nav-list-item--><!--    a.nav-list-link(class="search" href=url_for("search") target="_self") SEARCH--></ul></header><main class="container"></main><div class="post"><article class="post-block"><h1 class="post-title">Crypto Coven 加密女巫 NFT 合约解读</h1><div class="post-info">May 15, 2024<span class="categories"><i class="fa fa-bookmark" aria-hidden="true"></i></span><a href="/categories/%E6%8A%80%E6%9C%AF/" class="post-category">#技术</a><span>14 min. read</span></div><div class="post-content"><p>本文主要是对 <a href="https://twitter.com/mannynotfound" target="_blank" rel="noopener">@mannynotfound</a> 的推文 <a href="https://twitter.com/mannynotfound/status/1470535464922845187" target="_blank" rel="noopener">https://twitter.com/mannynotfound/status/1470535464922845187</a> 的整理和补充。</p>
<p>加密女巫的合约代码堪称艺术品。代码出自工程师 Matthew Di Ferrante(<a href="https://twitter.com/matthewdif" target="_blank" rel="noopener">@matthewdif</a>)，涉及 gas 优化，修改器以及 Opensea 预授权等诸多优化措施，对于学习 NFT 合约是个很好的参考材料。</p>
<h3><span id="ji-ben-qing-kuang">基本情况</span></h3>
<p>名称；Crypto Coven</p>
<p>符号： WITCH</p>
<p>合约地址：0x5180db8f5c931aae63c74266b211f580155ecac8</p>
<p>合约代码地址：<a href="https://etherscan.io/address/0x5180db8f5c931aae63c74266b211f580155ecac8#code" target="_blank" rel="noopener">https://etherscan.io/address/0x5180db8f5c931aae63c74266b211f580155ecac8#code</a></p>
<p>Solidity版本： <code>^0.8.0</code></p>
<a id="more"></a>
<h3><span id="banner">Banner</span></h3>
<p>这个 banner 可以体会到项目方想要做的不是像 Crypto Punks 或者其他像素风格 NFT 一样的作品。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line">.・。.・゜✭・.・✫・゜・。..・。.・゜✭・.・✫・゜・。.✭・.・✫・゜・。..・✫・゜・。.・。.・゜✭・.・✫・゜・。..・。.・゜✭・.・✫・゜・。.✭・.・✫・゜・。..・✫・゜・。</span><br><span class="line"></span><br><span class="line">                                                       s                                            _                                 </span><br><span class="line">                         ..                           :8                                           u                                  </span><br><span class="line">             .u    .    @L           .d``            .88           u.                       u.    88Nu.   u.                u.    u.  </span><br><span class="line">      .    .d88B :@8c  9888i   .dL   @8Ne.   .u     :888ooo  ...ue888b           .    ...ue888b  &apos;88888.o888c      .u     x@88k u@88c.</span><br><span class="line"> .udR88N  =&quot;8888f8888r `Y888k:*888.  %8888:u@88N  -*8888888  888R Y888r     .udR88N   888R Y888r  ^8888  8888   ud8888.  ^&quot;8888&quot;&quot;8888&quot;</span><br><span class="line">&lt;888&apos;888k   4888&gt;&apos;88&quot;    888E  888I   `888I  888.   8888     888R I888&gt;    &lt;888&apos;888k  888R I888&gt;   8888  8888 :888&apos;8888.   8888  888R </span><br><span class="line">9888 &apos;Y&quot;    4888&gt; &apos;      888E  888I    888I  888I   8888     888R I888&gt;    9888 &apos;Y&quot;   888R I888&gt;   8888  8888 d888 &apos;88%&quot;   8888  888R </span><br><span class="line">9888        4888&gt;        888E  888I    888I  888I   8888     888R I888&gt;    9888       888R I888&gt;   8888  8888 8888.+&quot;      8888  888R </span><br><span class="line">9888       .d888L .+     888E  888I  uW888L  888&apos;  .8888Lu= u8888cJ888     9888      u8888cJ888   .8888b.888P 8888L        8888  888R </span><br><span class="line">?8888u../  ^&quot;8888*&quot;     x888N&gt;&lt;888&apos; &apos;*88888Nu88P   ^%888*    &quot;*888*P&quot;      ?8888u../  &quot;*888*P&quot;     ^Y8888*&quot;&quot;  &apos;8888c. .+  &quot;*88*&quot; 8888&quot;</span><br><span class="line"> &quot;8888P&apos;      &quot;Y&quot;        &quot;88&quot;  888  ~ &apos;88888F`       &apos;Y&quot;       &apos;Y&quot;          &quot;8888P&apos;     &apos;Y&quot;          `Y&quot;       &quot;88888%      &quot;&quot;   &apos;Y&quot;  </span><br><span class="line">   &quot;P&apos;                         88F     888 ^                                  &quot;P&apos;                                &quot;YP&apos;                 </span><br><span class="line">                              98&quot;      *8E                                                                                            </span><br><span class="line">                            ./&quot;        &apos;8&gt;                                                                                            </span><br><span class="line">                           ~`           &quot;                                                                                             </span><br><span class="line"></span><br><span class="line">.・。.・゜✭・.・✫・゜・。..・。.・゜✭・.・✫・゜・。.✭・.・✫・゜・。..・✫・゜・。.・。.・゜✭・.・✫・゜・。..・。.・゜✭・.・✫・゜・。.✭・.・✫・゜・。..・✫・゜・。</span><br><span class="line">*/</span><br></pre></td></tr></table></figure>
<h3><span id="bi-mian-shi-yong-erc721enumerable">避免使用 ERC721Enumerable</span></h3>
<p>使用 <code>ERC721Enumerable</code> 会带来大量 gas 消耗，合约中使用 <code>ERC721 + Counters</code> 的方式节省 Gas。主要原因是由于 <code>totalSupply()</code> 函数的使用。</p>
<p>详细可以阅读文章：<a href="https://shiny.mirror.xyz/OUampBbIz9ebEicfGnQf5At_ReMHlZy0tB4glb9xQ0E" target="_blank" rel="noopener">Cut Minting Gas Costs By Up To 70% With One Smart Contract Tweak</a></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">contract CryptoCoven is ERC721, IERC2981, Ownable, ReentrancyGuard &#123;</span><br><span class="line">    using Counters for Counters.Counter;</span><br><span class="line">    using Strings for uint256;</span><br><span class="line"></span><br><span class="line">    Counters.Counter private tokenCounter;</span><br></pre></td></tr></table></figure>
<h3><span id="xiu-gai-qi-rang-dai-ma-geng-jian-ji-he-qing-xi">修改器让代码更简洁和清晰</span></h3>
<p>合约中使用修改器对权限进行控制，其中包括：</p>
<ul>
<li><code>publicSaleActive</code> 公开销售状态</li>
<li><code>communitySaleActive</code> 社区销售状态</li>
<li><code>maxWitchesPerWallet</code> 每个钱包最大 token 数量</li>
<li><code>canMintWitches</code> 控制token总数量</li>
<li><code>canGiftWitches</code></li>
<li><code>isCorrectPayment</code> 判断购买时价格是否正确</li>
<li><code>isValidMerkleProof</code> 用于白名单机制中的 Merkle 验证</li>
</ul>
<p>这些修改器可以使得权限控制更简便，代码的可读性也大大提升。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// ============ ACCESS CONTROL/SANITY MODIFIERS ============</span><br><span class="line"></span><br><span class="line">    modifier publicSaleActive() &#123;</span><br><span class="line">        require(isPublicSaleActive, &quot;Public sale is not open&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier communitySaleActive() &#123;</span><br><span class="line">        require(isCommunitySaleActive, &quot;Community sale is not open&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier maxWitchesPerWallet(uint256 numberOfTokens) &#123;</span><br><span class="line">        require(</span><br><span class="line">            balanceOf(msg.sender) + numberOfTokens &lt;= MAX_WITCHES_PER_WALLET,</span><br><span class="line">            &quot;Max witches to mint is three&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier canMintWitches(uint256 numberOfTokens) &#123;</span><br><span class="line">        require(</span><br><span class="line">            tokenCounter.current() + numberOfTokens &lt;=</span><br><span class="line">                maxWitches - maxGiftedWitches,</span><br><span class="line">            &quot;Not enough witches remaining to mint&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier canGiftWitches(uint256 num) &#123;</span><br><span class="line">        require(</span><br><span class="line">            numGiftedWitches + num &lt;= maxGiftedWitches,</span><br><span class="line">            &quot;Not enough witches remaining to gift&quot;</span><br><span class="line">        );</span><br><span class="line">        require(</span><br><span class="line">            tokenCounter.current() + num &lt;= maxWitches,</span><br><span class="line">            &quot;Not enough witches remaining to mint&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier isCorrectPayment(uint256 price, uint256 numberOfTokens) &#123;</span><br><span class="line">        require(</span><br><span class="line">            price * numberOfTokens == msg.value,</span><br><span class="line">            &quot;Incorrect ETH value sent&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier isValidMerkleProof(bytes32[] calldata merkleProof, bytes32 root) &#123;</span><br><span class="line">        require(</span><br><span class="line">            MerkleProof.verify(</span><br><span class="line">                merkleProof,</span><br><span class="line">                root,</span><br><span class="line">                keccak256(abi.encodePacked(msg.sender))</span><br><span class="line">            ),</span><br><span class="line">            &quot;Address does not exist in list&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3><span id="nft-su-cai-de-cun-chu">NFT 素材的存储</span></h3>
<p>NFT 项目都需要包含图片的存储，合约将 NFT 对应的元信息存储在 IPFS 中，并将对应的图片存储都在 Amazon S3 存储中。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">string private baseURI;    </span><br><span class="line"></span><br><span class="line">function setBaseURI(string memory _baseURI) external onlyOwner &#123;</span><br><span class="line">    baseURI = _baseURI;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * @dev See &#123;IERC721Metadata-tokenURI&#125;.</span><br><span class="line"> */</span><br><span class="line">function tokenURI(uint256 tokenId)</span><br><span class="line">    public</span><br><span class="line">    view</span><br><span class="line">    virtual</span><br><span class="line">    override</span><br><span class="line">    returns (string memory)</span><br><span class="line">&#123;</span><br><span class="line">    require(_exists(tokenId), &quot;Nonexistent token&quot;);</span><br><span class="line"></span><br><span class="line">    return</span><br><span class="line">        string(abi.encodePacked(baseURI, &quot;/&quot;, tokenId.toString(), &quot;.json&quot;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>比如 <code>tokenId</code> 为 <code>1</code> 的 NFT，对应的 <code>tokenURI</code> 为 <code>ipfs://QmZHKZDavkvNfA9gSAg7HALv8jF7BJaKjUc9U2LSuvUySB/1.json</code>，在 IPFS 中可以看到这里面的内容为：</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">"You are a WITCH of the highest order. You are borne of chaos that gives the night shape. Your magic spawns from primordial darkness. You are called oracle by those wise enough to listen. ALL THEOLOGY STEMS FROM THE TERROR OF THE FIRMAMENT!"</span>,</span><br><span class="line">  <span class="attr">"external_url"</span>: <span class="string">"https://www.cryptocoven.xyz/witches/1"</span>,</span><br><span class="line">  <span class="attr">"image"</span>: <span class="string">"https://cryptocoven.s3.amazonaws.com/nyx.png"</span>,</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"nyx"</span>,</span><br><span class="line">  <span class="attr">"background_color"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"attributes"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Background"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Sepia"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Skin Tone"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Dawn"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Body Shape"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Lithe"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Top"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Sheer Top (Black)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Eyebrows"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Medium Flat (Black)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Eye Style"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Nyx"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Eye Color"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Cloud"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Mouth"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Nyx (Mocha)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Hair (Front)"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Nyx"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Hair (Back)"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Nyx Long"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Hair Color"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Steel"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Hat"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Witch (Black)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Necklace"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Moon Necklace (Silver)"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Archetype of Power"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Witch of Woe"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Sun Sign"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Taurus"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Moon Sign"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Aquarius"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Rising Sign"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="string">"Capricorn"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"display_type"</span>: <span class="string">"number"</span>,</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Will"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"display_type"</span>: <span class="string">"number"</span>,</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Wisdom"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"display_type"</span>: <span class="string">"number"</span>,</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Wonder"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"display_type"</span>: <span class="string">"number"</span>,</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Woe"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">10</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"display_type"</span>: <span class="string">"number"</span>,</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Wit"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"display_type"</span>: <span class="string">"number"</span>,</span><br><span class="line">      <span class="attr">"trait_type"</span>: <span class="string">"Wiles"</span>,</span><br><span class="line">      <span class="attr">"value"</span>: <span class="number">9</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"coven"</span>: &#123;</span><br><span class="line">    <span class="attr">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"nyx"</span>,</span><br><span class="line">    <span class="attr">"type"</span>: <span class="string">"Witch of Woe"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: &#123;</span><br><span class="line">      <span class="attr">"intro"</span>: <span class="string">"You are a WITCH of the highest order."</span>,</span><br><span class="line">      <span class="attr">"hobby"</span>: <span class="string">"You are borne of chaos that gives the night shape."</span>,</span><br><span class="line">      <span class="attr">"magic"</span>: <span class="string">"Your magic spawns from primordial darkness."</span>,</span><br><span class="line">      <span class="attr">"typeSpecific"</span>: <span class="string">"You are called oracle by those wise enough to listen."</span>,</span><br><span class="line">      <span class="attr">"exclamation"</span>: <span class="string">"ALL THEOLOGY STEMS FROM THE TERROR OF THE FIRMAMENT!"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"skills"</span>: &#123;</span><br><span class="line">      <span class="attr">"will"</span>: <span class="number">9</span>,</span><br><span class="line">      <span class="attr">"wisdom"</span>: <span class="number">9</span>,</span><br><span class="line">      <span class="attr">"wonder"</span>: <span class="number">9</span>,</span><br><span class="line">      <span class="attr">"woe"</span>: <span class="number">10</span>,</span><br><span class="line">      <span class="attr">"wit"</span>: <span class="number">9</span>,</span><br><span class="line">      <span class="attr">"wiles"</span>: <span class="number">9</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"birthChart"</span>: &#123;</span><br><span class="line">      <span class="attr">"sun"</span>: <span class="string">"taurus"</span>,</span><br><span class="line">      <span class="attr">"moon"</span>: <span class="string">"aquarius"</span>,</span><br><span class="line">      <span class="attr">"rising"</span>: <span class="string">"capricorn"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"styles"</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"background"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"solid"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"sepia"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"background_solid_sepia"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"base"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"lithe"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"dawn"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"base_lithe_dawn"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"body-under"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"sheer-top"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"black"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"body-under_sheer-top_black"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"eyebrows"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"medium-flat"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"black"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"eyebrows_medium-flat_black"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"eyes"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nyx"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"cloud"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"eyes_nyx_cloud"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"mouth"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nyx"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"mocha"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"mouth_nyx_mocha"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"hair-back"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nyx"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"steel"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"hair-back_nyx_steel"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"hair-bangs"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"nyx"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"steel"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"hair-bangs_nyx_steel"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"hat-back"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"witch"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"black"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"hat-back_witch_black"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"hat-front"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"witch"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"black"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"hat-front_witch_black"</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">"attribute"</span>: <span class="string">"necklace"</span>,</span><br><span class="line">        <span class="attr">"name"</span>: <span class="string">"moon-necklace"</span>,</span><br><span class="line">        <span class="attr">"color"</span>: <span class="string">"silver"</span>,</span><br><span class="line">        <span class="attr">"fullName"</span>: <span class="string">"necklace_moon-necklace_silver"</span></span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"hash"</span>: <span class="string">"nyx"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中包含女巫的ID，名称，图片地址，属性等信息。</p>
<p>不得不说，如果 Amazon S3 出问题了，可能这些图片就没法显示了。</p>
<h3><span id="shi-yong-merkle-zheng-ming-shi-xian-bai-ming-dan-ji-zhi">使用 Merkle 证明实现白名单机制</span></h3>
<p>对于预售，项目方使用白名单方式进行，而对于白名单验证，合约中使用 Merkle 证明的方式进行验证。</p>
<p>在 mint 时，只需发送正确的 Merkle 证明来验证即可实现白名单功能，这个方法不仅效率高，而且省去了在合约中存储所有白名单地址造成的 Gas 消耗。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    modifier isValidMerkleProof(bytes32[] calldata merkleProof, bytes32 root) &#123;</span><br><span class="line">        require(</span><br><span class="line">            MerkleProof.verify(</span><br><span class="line">                merkleProof,</span><br><span class="line">                root,</span><br><span class="line">                keccak256(abi.encodePacked(msg.sender))</span><br><span class="line">            ),</span><br><span class="line">            &quot;Address does not exist in list&quot;</span><br><span class="line">        );</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">    function mintCommunitySale(</span><br><span class="line">        uint8 numberOfTokens,</span><br><span class="line">        bytes32[] calldata merkleProof</span><br><span class="line">    )</span><br><span class="line">        external</span><br><span class="line">        payable</span><br><span class="line">        nonReentrant</span><br><span class="line">        communitySaleActive</span><br><span class="line">        canMintWitches(numberOfTokens)</span><br><span class="line">        isCorrectPayment(COMMUNITY_SALE_PRICE, numberOfTokens)</span><br><span class="line">        isValidMerkleProof(merkleProof, communitySaleMerkleRoot)</span><br><span class="line">    &#123;</span><br><span class="line">        // ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function claim(bytes32[] calldata merkleProof)</span><br><span class="line">        external</span><br><span class="line">        isValidMerkleProof(merkleProof, claimListMerkleRoot)</span><br><span class="line">        canGiftWitches(1)</span><br><span class="line">    &#123;</span><br><span class="line">			// ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>详细细节可以参考我之前的一篇文章：</p>
<h3><span id="yu-xian-pi-zhun-opensea-he-yue">预先批准 Opensea 合约</span></h3>
<p>可以看到在 OpenSea 上列出这些 NFT 费用为 0 gas，因为合约预先批准了 OpenSea 合约以节省用户的 gas，同时合约还包括一个紧急功能来消除这种行为！</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">    /**</span><br><span class="line">     * @dev Override isApprovedForAll to allowlist user&apos;s OpenSea proxy accounts to enable gas-less listings.</span><br><span class="line">     */</span><br><span class="line">    function isApprovedForAll(address owner, address operator)</span><br><span class="line">        public</span><br><span class="line">        view</span><br><span class="line">        override</span><br><span class="line">        returns (bool)</span><br><span class="line">    &#123;</span><br><span class="line">        // Get a reference to OpenSea&apos;s proxy registry contract by instantiating</span><br><span class="line">        // the contract using the already existing address.</span><br><span class="line">        ProxyRegistry proxyRegistry = ProxyRegistry(</span><br><span class="line">            openSeaProxyRegistryAddress</span><br><span class="line">        );</span><br><span class="line">        if (</span><br><span class="line">            isOpenSeaProxyActive &amp;&amp;</span><br><span class="line">            address(proxyRegistry.proxies(owner)) == operator</span><br><span class="line">        ) &#123;</span><br><span class="line">            return true;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return super.isApprovedForAll(owner, operator);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">// These contract definitions are used to create a reference to the OpenSea</span><br><span class="line">// ProxyRegistry contract by using the registry&apos;s address (see isApprovedForAll).</span><br><span class="line">contract OwnableDelegateProxy &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ProxyRegistry &#123;</span><br><span class="line">    mapping(address =&gt; OwnableDelegateProxy) public proxies;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为了防止 Opensea 关闭或者被入侵，合约可以通过 <code>setIsOpenSeaProxyActive</code> 方法关闭预先批准。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">// function to disable gasless listings for security in case</span><br><span class="line">// opensea ever shuts down or is compromised</span><br><span class="line">function setIsOpenSeaProxyActive(bool _isOpenSeaProxyActive)</span><br><span class="line">    external</span><br><span class="line">    onlyOwner</span><br><span class="line">&#123;</span><br><span class="line">    isOpenSeaProxyActive = _isOpenSeaProxyActive;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="erc165">ERC165</span></h3>
<p>这是一种发布并能检测到一个智能合约实现了什么接口的标准，用于实现对合约实现的接口的查询。这个标准需要实现 <code>suppoetsInterface</code> 方法：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">interface ERC165 &#123;</span><br><span class="line">    /// @notice Query if a contract implements an interface</span><br><span class="line">    /// @param interfaceID The interface identifier, as specified in ERC-165</span><br><span class="line">    /// @dev Interface identification is specified in ERC-165. This function</span><br><span class="line">    ///  uses less than 30,000 gas.</span><br><span class="line">    /// @return `true` if the contract implements `interfaceID` and</span><br><span class="line">    ///  `interfaceID` is not 0xffffffff, `false` otherwise</span><br><span class="line">    function supportsInterface(bytes4 interfaceID) external view returns (bool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加密女巫实现复写这个方法是因为它额外实现了 EIP2981 这个标准，需要指出。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">function supportsInterface(bytes4 interfaceId)</span><br><span class="line">    public</span><br><span class="line">    view</span><br><span class="line">    virtual</span><br><span class="line">    override(ERC721, IERC165)</span><br><span class="line">    returns (bool)</span><br><span class="line">&#123;</span><br><span class="line">    return</span><br><span class="line">        interfaceId == type(IERC2981).interfaceId ||</span><br><span class="line">        super.supportsInterface(interfaceId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3><span id="eip2981-nft-ban-shui-biao-zhun">EIP2981：NFT 版税标准</span></h3>
<p>EIP-2981 实现了标准化的版税信息检索，可被任何类型的 NFT 市场接受。EIP-2981 支持所有市场检索特定 NFT 的版税支付信息，从而实现无论 NFT 在哪个市场出售或转售都可以实现准确的版税支付。</p>
<p>NFT 市场和个人可通过检索版税支付信息 <code>royaltyInfo()</code> 来实施该标准，它指定为特定的 NFT 销售价格向指定的单一地址支付特定比例的金额。对于特定的 <code>tokenId</code> 和 <code>salePrice</code>，在请求时需提供一个版税接收者的地址和要支付的预期版税金额（<em>百分比表示</em>）。</p>
<p>女巫合约规定了 5% 的版税，但是这个标准并不是强制性的，需要靠市场去实施此标准。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * @dev See &#123;IERC165-royaltyInfo&#125;.</span><br><span class="line"> */</span><br><span class="line">function royaltyInfo(uint256 tokenId, uint256 salePrice)</span><br><span class="line">    external</span><br><span class="line">    view</span><br><span class="line">    override</span><br><span class="line">    returns (address receiver, uint256 royaltyAmount)</span><br><span class="line">&#123;</span><br><span class="line">    require(_exists(tokenId), &quot;Nonexistent token&quot;);</span><br><span class="line"></span><br><span class="line">    return (address(this), SafeMath.div(SafeMath.mul(salePrice, 5), 100));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不太确定此函数中的注释 <code>See {IERC165-royaltyInfo}.</code> 是否正确，需要确认。</p>
<h3><span id="qi-ta-xi-jie">其他细节</span></h3>
<ol>
<li>
<p>没有 <code>tokensOfOwner</code> 方法</p>
<p>可能是基于女巫NFT的具体场景与优化 Gas 做的权衡，查询 token 所有者的功能需要靠 Opensea 的 API 或者 The Graph 去实现。</p>
</li>
</ol>
<ol start="2">
<li>
<p>在没有外部调用的函数中也加了 <code>nonReentrant</code></p>
</li>
<li>
<p><code>msg.sender</code> 可能是合约</p>
</li>
<li>
<p>对 <code>onlyOwner</code> 也加了 <code>nonReentrant</code>，避免可能的被利用。</p>
</li>
</ol>
<h3><span id="can-kao">参考</span></h3>
<ol>
<li><strong><a href="https://mp.weixin.qq.com/s/DVUYmHLJE75GJ2ATdtYhEw" target="_blank" rel="noopener">为什么说 EIP-2981 的生效对于 NFT 创作者来说至关重要？</a></strong></li>
</ol>
<h3><span id="comments">Comments</span></h3>
</div><p class="post-tags"><i class="fa fa-tags" aria-hidden="true"></i><a href="/tags/%E5%8C%BA%E5%9D%97%E9%93%BE/">#区块链</a></p></article></div><div class="post-copyright"><blockquote><p>版权声明：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">署名-相同方式共享 | CC BY-SA 4.0 </a>许可协议。</p></blockquote></div><footer><div class="paginator"><a href="/qiwihui-blog-160/" class="prev">PREV</a><a href="/qiwihui-blog-148/" class="next">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'blog-qiwihui-com';
var disqus_identifier = 'qiwihui-blog-152/';
var disqus_title = 'Crypto Coven 加密女巫 NFT 合约解读';
var disqus_url = 'https://qiwihui.com/qiwihui-blog-152/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//blog-qiwihui-com.disqus.com/count.js" async></script><!-- block copyright--></footer></div><script async src="//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        processEnvironments: true,
        skipTags: ["script","noscript","style","textarea","code","pre"]
    }
});
</script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-46660488-3",'auto');ga('send','pageview');</script><link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.min.css" media="screen" type="text/css"><script src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script><script>$(function(){$('.datatable').dataTable( {"order": [[ 0, "desc" ]],"iDisplayLength": -1,"lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]]} );});</script></body></html>